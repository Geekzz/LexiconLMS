@page "/admin"
@rendermode InteractiveWebAssembly

@using LMS.Blazor.Client.Components
@using LMS.Blazor.Client.Services
@using LMS.Shared.DTOs
@using LMS.Shared.DTOs.Read
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization

@attribute [Authorize]

<AuthorizeView>
    <Authorized>
        <div class="container mx-auto mt-5">
            @if (courses == null)
            {
                <LoadingSpinner />
            }
            else if (!courses.Any())
            {
                <p>No courses available.</p>
            }
            else
            {
                <div class="d-flex justify-content-center">
                    <div class="flex-grow-1">
                        <div class="row justify-content-center">
                            @foreach (var course in courses)
                            {
                                <CourseCard Course="course" />
                            }
                        </div>
                        <div class="row justify-content-center">
                            <UserCard Users="users" />
                        </div>
                    </div>

                    <div class="position-fixed" style="top: 50%; right: 20px;">
                        <a class="btn lexicon-button mb-2 button-fontsize">Ny kurs</a>
                        <a class="btn lexicon-button button-fontsize" href="Account/Register">Ny användare</a>
                    </div>
                </div>
            }
        </div>
    </Authorized>
    <NotAuthorized>
        <div class="container text-center mt-5">
            <p>You are not authorized to view this page.</p>
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    [Inject]
    private IApiService _apiService { get; set; } = default!;
    [Inject]
    private AuthenticationStateProvider AuthenticationStateProvider { get; set; } = default!;

    private List<CourseDto>? courses;
    private List<UserDto>? users;

    protected override async Task OnInitializedAsync()
    {
        await FetchCoursesAsync();
    }

    private async Task FetchCoursesAsync()
    {
        try
        {
            courses = (await _apiService.GetAsync<List<CourseDto>>("courses")).ToList();
            users = (await _apiService.GetAsync<List<UserDto>>("users")).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error while fetching courses: {ex.Message}");
        }
    }
}
